# Установка Диспетчера Hyper-V и удалённое управление сервером в недоменной среде

## Сервер

1. **Проверка совместимости оборудования**: Убедитесь, что сервер удовлетворяет требованиям для установки роли Hyper-V. Выполните команду:

   ```powershell
   systeminfo
   ```


   В разделе "Требования к Hyper-V" должны поддерживаться все функции.

2. **Установка роли Hyper-V**: Установите роль Hyper-V с включением инструментов управления и перезагрузкой сервера:

   ```powershell
   Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
   ```


3. **Активация Windows**: Активируйте операционную систему с помощью команд:

   ```powershell
   slmgr /ipk <ключ_соответствующий_версии_ОС>
   slmgr /skms <адрес_kms_сервера>:<порт>
   slmgr /ato
   ```


4. **Проверка установки роли**: Убедитесь, что роль Hyper-V установлена:

   ```powershell
   Get-WindowsFeature -Name Hyper-V
   ```


5. **Настройка сервера с помощью `sconfig`**:

   - Запустите утилиту:

     ```powershell
     sconfig
     ```

   - Выполните следующие действия:

     - Задайте имя компьютера (hostname).

     - Разрешите удалённое управление.

     - Разрешите ICMP-ответы (пинги).

     - Установите правильный часовой пояс.

6. **Включение удалённого управления**: Настройте сервер для удалённого управления:

   ```powershell
   Enable-PSRemoting
   Enable-WSManCredSSP -Role Server
   winrm quickconfig
   ```


7. **Проверка настроек**:

   - Проверяем с какими настройками слушает WinRM:

     ```powershell
     winrm enumerate winrm/config/listener
     ```

   - Проверьте состояние службы управления виртуальными машинами:

     ```powershell
     Get-Service -Name vmms
     ```

## Клиент

1. **Установка Диспетчера Hyper-V**:

   - Откройте "Программы и компоненты" с помощью команды:

     ```powershell
     appwiz.cpl
     ```

   - Выберите "Включение или отключение компонентов Windows".

   - Установите флажок "Средства управления Hyper-V".

2. **Проверка доступности сервера**: Убедитесь, что сервер доступен по порту 5985:

   ```powershell
   Test-NetConnection -ComputerName 192.168.21.30 -Port 5985
   ```


3. **Добавление записи в файл hosts**: Если отсутствует локальный DNS, добавьте запись в файл hosts:

   ```powershell
   Add-Content -Path "C:\Windows\System32\drivers\etc\hosts" -Value "192.168.21.30 hv19"
   ```


4. **Сохранение учетных данных для доступа к серверу**: Сохраните учетные данные для подключения к серверу:

   ```powershell
   cmdkey /add:hv19 /user:Administrator /pass:HVpa66w0ddr
   ```


5. **Проверка и запуск службы WinRM**:

   - Проверьте состояние службы:

     ```powershell
     Get-Service -Name WinRM
     ```

   - При необходимости запустите службу:

     ```powershell
     Start-Service -Name WinRM
     ```

6. **Включение аутентификации CredSSP**: Разрешите делегирование учетных данных для сервера:

   ```powershell
   Enable-WSManCredSSP -Role Client -DelegateComputer "hv19"
   ```


7. **Проверка настроек WinRM**: Убедитесь, что настройки клиента корректны:

   ```powershell
   winrm get winrm/config/client
   ```


8. **Настройка групповых политик**:

   - Откройте редактор локальной групповой политики:

     ```powershell
     gpedit.msc
     ```

   - Перейдите в раздел:

     ```
     Конфигурация компьютера -> Административные шаблоны -> Система -> Передача учетных данных
     ```

   - "Разрешить делегирование новых учетных данных" - должна быть включена

   - Включите политику "Разрешить делегирование новых учетных данных с проверкой подлинности только NTLM" и добавьте сервер в список, например:

     ```
     WSMAN/hv19
     WSMAN/*.example.com
     WSMAN/192.168.21.30
     WSMAN/*
     ```

9. **Применение политик**: Обновите групповые политики:

   ```powershell
   gpupdate /force
   ```


**Примечание**: Сетевое имя, используемое для подключения, должно совпадать с именем хоста сервера.
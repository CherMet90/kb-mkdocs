```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONTROL PLANE (IKEv2)                            │
│                                                                             │
│  ┌─────────────────┐         ┌─────────────────┐         ┌───────────────┐  │
│  │  ikev2 policy   │────────▶│ ikev2 proposal  │         │ ikev2 keyring │  │
│  │                 │ (1:N)   │                 │         │               │  │
│  │ • match criteria│         │ • encryption    │         │ • peer IP     │  │
│  │ • proposal order│         │ • prf           │         │ • PSK         │  │
│  └─────────────────┘         │ • dh group      │         └───────┬───────┘  │
│          │                   └─────────────────┘                 │          │
│          │ ГЛОБАЛЬНО                                             │ (1:1)    │
│          │ (без явных ссылок)                                    ▼          │
│          │                                           ┌─────────────────┐    │
│          │                                           │  ikev2 profile  │    │
│          │                                           │                 │    │
│          │                                           │ • match local   │    │
│          │                                           │ • match remote  │    │
│          │                                           │ • identity      │    │
│          │                                           │ • lifetime      │    │
│          │                                           │ • dpd           │    │
│          │                                           └────────┬────────┘    │
│          │                                                    │             │
└──────────┼────────────────────────────────────────────────────┼─────────────┘
           │                                                    │
           │ автоматически                          явно или автоматически
           │ применяется                                        │
           ▼                                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DATA PLANE (IPsec)                               │
│                                                                             │
│  ┌───────────────────┐       ┌─────────────────────┐       ┌─────────────┐  │
│  │ ipsec transform   │◀──────│    ipsec profile    │◀──────│   Tunnel    │  │
│  │                   │ (1:N) │                     │ (1:1) │             │  │
│  │ • esp encryption  │       │ • transform-set     │       │ • source    │  │
│  │ • esp integrity   │       │ • pfs group         │       │ • dest      │  │
│  │ • mode            │       │ • SA lifetime       │       │ • mode      │  │
│  └───────────────────┘       │ • [set ikev2-profile] ◀─────│ • защита    │  │
│                              └─────────────────────┘       └─────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### Последовательность настройки
- ikev2 proposal*
- ikev2 policy*. В политике определяются proposal и их порядок (порядок не всегда соблюдается пиром, пир может выбирать самый слабый вариант - это нужно учитывать), которые будут предложены пиру. Политики имеют глобальный scope, т.е. их может использовать любой тунель подпадающий под критерии. Критериями политики могут выступать local address (внешний) и fvrf. Более специфичная политика обычно имеет приоритет над общей. Таким образом можно создать политику (fvrf any без match local address) со списком желаемых proposal, а в случае если они не подходят - создать более специфичную политику с другим списком proposal
- ikev2 keyring. создаём пару remote address:PSK
- ikev2 profile. Указываем match критерии (address local и identity remote address), как представляемся пиру identity local address, способ аутентификации, ссылка на keyring, IKE lifetime, dpd
- ipsec transform-set*. ipsec encryption и mode (tunnel/transport)
- ipsec profile. ссылка на подходящие transform-set, pfs группа, SA lifetime, ссылка на ikev2 профиль (обязательно, если мы initiator)
- создаём тунель

NOTE: *можно переиспользовать для разных тунелей